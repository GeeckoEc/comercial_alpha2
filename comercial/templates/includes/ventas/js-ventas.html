<script>
    $(document).ready(() => {
        clientes()
    })

    function clientes () {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        });
        $.ajax({
            url:        '{% url "gestion_clientes" %}',
            type:       'POST',
            dataType:   'JSON',
            data:       {
                accion:     'lista_clientes',
                estado:     true
            }
        }).then((respuesta) => {
            $.each(respuesta.clientes, (index, cliente) => {
                $('#clientes').append(`
                    <option value="${cliente.identificacion}">${cliente.nombre} ${cliente.apellido} - ${cliente.identificacion}</option>
                `)
            })
        }).catch((error) => {
            let respuesta = JSON.parse(error.responseText)
            mensaje('fa fa-circle-xmark', 'Error en Lista de Clientes', 'red', respuesta.message)
        })
    }

    function datos_cliente(identificacion) {
        $.ajax({
            url:        '{% url "gestion_clientes" %}',
            type:       'POST',
            dataType:   'JSON',
            data:       {
                accion:         'datos_cliente',
                identificacion: identificacion
            }
        }).then((respuesta) => {
            $('#nombre-completo').val(respuesta.cliente.nombre + ' ' + respuesta.cliente.apellido)
            $('#mostrar-direccion').val(respuesta.cliente.direccion)
            $('#mostrar-telefono').val(respuesta.cliente.telefono)
            $('#mostrar-celular').val(respuesta.cliente.celular)
        }).catch((error) => {
            let respuesta = JSON.parse(error.responseText)
            mensaje('fa fa-circle-xmark', 'Error de Cliente', 'red', respuesta.message)
        })
    }

    function nuevo_cliente () {
        $('.modal-body').html(`
            <form>
                <div class="form-floating mb-3">
                    <input type="text" name="nombre" id="nombre" class="form-control" placeholder="nombre">
                    <label for="nombre">Nombres</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="apellido" id="apellido" class="form-control" placeholder="apellido">
                    <label for="apellido">Apellidos</label>
                </div>
                <div class="form-floating mb-3">
                    <select name="tipo_identificacion" id="tipo_identificacion" class="form-select" placeholder="tipo_identificacion">
                        <option value="0">[Seleccione un tipo de identificacion]</option>
                        <option value="cedula">Cédula</option>
                        <option value="ruc">RUC</option>
                    </select>
                    <label for="tipo_identificacion">Tipo de Identificación</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="identificacion" id="identificacion" class="form-control" placeholder="identificacion">
                    <label for="identificacion">Identificación</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="direccion" id="direccion" class="form-control" placeholder="direccion">
                    <label for="direccion">Direccion</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="ciudad" id="ciudad" class="form-control" placeholder="ciudad">
                    <label for="ciudad">Ciudad</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="telefono" id="telefono" class="form-control" placeholder="telefono">
                    <label for="telefono">Teléfono</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="celular" id="celular" class="form-control" placeholder="celular">
                    <label for="celular">Celular</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" name="correo" id="correo" class="form-control" placeholder="correo">
                    <label for="correo">Correo</label>
                </div>
                <button type="button" class="btn btn-primary form-control" onclick="guardar()">Guardar</button>
            </form>
        `)
        $('#etiqueta-modal-ventas').html('Nuevo Cliente')
        $('#modal-ventas').modal('toggle')
    }

    function guardar () {
        $.ajax({
            url:        '{% url "gestion_clientes" %}',
            type:       'POST',
            dataType:   'JSON',
            data:       {
                accion:     'crear_cliente',
                nombre:                 $('#nombre').val(),
                apellido:               $('#apellido').val(),
                tipo_identificacion:    $('#tipo_identificacion').val(),
                identificacion:         $('#identificacion').val(),
                direccion:              $('#direccion').val(),
                ciudad:                 $('#ciudad').val(),
                telefono:               $('#telefono').val(),
                celular:                $('#celular').val(),
                correo:                 $('#correo').val(),
            }
        }).then((respuesta) => {
            $('#modal-ventas').modal('toggle')
            mensaje('fa fa-circle-check', 'Guardar Cliente', 'green', respuesta.message)
            $('#cliente').val(respuesta.identificacion)
            clientes()
            datos_cliente(respuesta.identificacion)
        }).catch((error) => {
            let respuesta = JSON.parse(error.responseText)
            mensaje('fa fa-circle-xmark', 'Error al Guardar Cliente', 'red', respuesta.message)
        })
    }

    function mensaje (icono, titulo, color, mensaje) {
        $.alert({
            icon:               icono,
            type:               color,
            title:              titulo,
            content:            mensaje,
            theme:              'modern',
            animateFromElement: false,
            buttons:            {
                Cerrar:     () => {}
            }
        })
    }
</script>